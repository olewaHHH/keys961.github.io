---
layout: post
title: "JVM堆内存分析"
author: "keys961"
comments: true
---

## 1. `jmap`

`jmap`工具可以很好地去分析一个Java进程堆内存的情况，并生成dump文件。

常用的有：

- `jmap -heap <pid>`: 对PID进程进行堆分析，可以看到堆内存分配的配置，以及堆内存各个区域的占用情况

```
Heap Configuration:
   MinHeapFreeRatio         = 0
   MaxHeapFreeRatio         = 100
   MaxHeapSize              = 4263510016 (4066.0MB)
   NewSize                  = 89128960 (85.0MB)
   MaxNewSize               = 1420820480 (1355.0MB)
   OldSize                  = 179306496 (171.0MB)
   NewRatio                 = 2
   SurvivorRatio            = 8
   MetaspaceSize            = 21807104 (20.796875MB)
   CompressedClassSpaceSize = 1073741824 (1024.0MB)
   MaxMetaspaceSize         = 17592186044415 MB
   G1HeapRegionSize         = 0 (0.0MB)

Heap Usage:
PS Young Generation
Eden Space:
   capacity = 1103101952 (1052.0MB)
   used     = 43295592 (41.289894104003906MB)
   free     = 1059806360 (1010.7101058959961MB)
   3.924894876806455% used
From Space:
   capacity = 110100480 (105.0MB)
   used     = 109700880 (104.61891174316406MB)
   free     = 399600 (0.3810882568359375MB)
   99.63705880301339% used
To Space:
   capacity = 167247872 (159.5MB)
   used     = 0 (0.0MB)
   free     = 167247872 (159.5MB)
   0.0% used
PS Old Generation
   capacity = 385875968 (368.0MB)
   used     = 251045376 (239.41552734375MB)
   free     = 134830592 (128.58447265625MB)
   65.05856721297555% used

36764 interned Strings occupying 4003016 bytes.
```

- `jmap -dump:format=b, file=<filename> <pid>`: 对PID进程堆内存区域进行dump，生成二进制的转储文件，一般还需要压缩，它可以被用于MAT工具以进一步分析
- `jmap -histo[:live] <pid>`: 对PID进程进行堆内存（可选活跃对象）分析，生成统计文本，一般像这样：

```
num     #instances         #bytes  class name
----------------------------------------------
   1:       1597147       86346272  [Ljava.lang.Object;
   2:       1383173       55326920  java.util.TreeMap$Entry
   3:        585564       37193120  [C
   4:       1495556       35893344  java.util.ArrayList
```

## 2. 使用 Memory Analyzer 分析问题

MAT可提供多种分析维度，如：

- Histogram: 列出内存中的对象，对象的个数以及大小
- Dominator Tree: 列出那个线程，以及线程下面的那些对象占用的空间
- Top Consumers：通过图形列出哪些对象消耗最大的空间
- Leak Suspects: 分析内存泄漏